{"files":[{"id":"af1f49ed-2abb-4f2f-bf0e-4ad037f840f5","name":"appsscript","type":"json","source":"{\n  \"timeZone\": \"America/Argentina/Buenos_Aires\",\n  \"dependencies\": {\n    \"libraries\": [\n      {\n        \"userSymbol\": \"FirebaseApp\",\n        \"libraryId\": \"1hguuh4Zx72XVC1Zldm_vTtcUUKUA6iBUOoGnJUWLfqDWx5WlOJHqYkrt\",\n        \"version\": \"11\"\n      }\n    ]\n  },\n  \"webapp\": {\n    \"executeAs\": \"USER_DEPLOYING\",\n    \"access\": \"ANYONE_ANONYMOUS\"\n  },\n  \"exceptionLogging\": \"STACKDRIVER\",\n  \"runtimeVersion\": \"V8\"\n}"},{"id":"7eb83a38-83e9-46dc-942b-fefe9c208d44","name":"a. Inicio","type":"server_js","source":"const FB \u003d FirebaseApp.getDatabaseByUrl(\u0027https://infrapp-ar-default-rtdb.firebaseio.com/\u0027,\u00271AJG7DgPopDbSWcg93n7BMqTmYcCJEk3WMFHVUQk\u0027);\nconst month \u003d {0:\u0027ENE\u0027,1:\u0027FEB\u0027,2:\u0027MAR\u0027,3:\u0027ABR\u0027,4:\u0027MAY\u0027,5:\u0027JUN\u0027,6:\u0027JUL\u0027,7:\u0027AGO\u0027,8:\u0027SET\u0027,9:\u0027OCT\u0027,10:\u0027NOV\u0027,11:\u0027DIC\u0027}\n\nfunction doPost(e) {\n  \n  let result \u003d false;\n  if(e.parameter.action \u003d\u003d \u0027login\u0027)           {result \u003d Login(e.parameter)}\n  else if(e.parameter.action \u003d\u003d \u0027changePass\u0027) {result \u003d changePass(e.parameter)}\n\n  else if(e.parameter.action \u003d\u003d \u0027openTK\u0027)     {result \u003d openTK()}\n  else if(e.parameter.action \u003d\u003d \u0027newTK\u0027)      {result \u003d setTK(JSON.parse(e.parameter.content))}\n  else if(e.parameter.action \u003d\u003d \u0027getTK\u0027)      {result \u003d FB.getData(\u0027APPS/TK/\u0027+e.parameter.id)}\n\n  else if(e.parameter.action \u003d\u003d \u0027getMonitor\u0027) {result \u003d getMonitor()}\n  else if(e.parameter.action \u003d\u003d \u0027posterQR\u0027)   {result \u003d posterQR(e.parameter.id)}\n  else if(e.parameter.action \u003d\u003d \u0027idqr\u0027)       {result \u003d FB.getData(\u0027APPS/MONITOREO/\u0027+e.parameter.id)}\n\n  else if(e.parameter.action \u003d\u003d \u0027getIgm\u0027)     {result \u003d getIgm(e.parameter.site)}\n  else if(e.parameter.action \u003d\u003d \u0027setfirma\u0027)   {result \u003d setFirma(e.parameter)}\n  else if(e.parameter.action \u003d\u003d \u0027getForm\u0027)    {result \u003d getForm(e.parameter.form)}\n  else if(e.parameter.action \u003d\u003d \u0027setForm\u0027)    {result \u003d setForm(e.parameter)}\n\n  else if(e.parameter.action \u003d\u003d \u0027openWatch\u0027)  {result \u003d openWatch()}\n  else if(e.parameter.action \u003d\u003d \u0027setWatch\u0027)   {result \u003d setWatch(JSON.parse(e.parameter.data))}\n\n  else if(e.parameter.action \u003d\u003d \u0027openWaha\u0027)   {result \u003d openWaha()}\n  else if(e.parameter.action \u003d\u003d \u0027getWaha\u0027)    {result \u003d getWaha(e.parameter.id)}\n\n  else if(e.parameter.action \u003d\u003d \u0027getAccBase\u0027) {result \u003d getAccessBase()}\n  else if(e.parameter.action \u003d\u003d \u0027getAccFile\u0027) {result \u003d getAccesFile(JSON.parse(e.parameter.search))}\n  else if(e.parameter.action \u003d\u003d \u0027upAccData\u0027 ) {result \u003d upAccData(e.parameter.site,JSON.parse(e.parameter.data))}\n  else if(e.parameter.action \u003d\u003d \u0027searchAccs\u0027) {result \u003d searchAccs(JSON.parse(e.parameter.search))}\n\n  else if(e.parameter.action \u003d\u003d \u0027getApp\u0027){\n    result \u003d {monitor:getMonitor(),tickets:openTK(),matriz:getMatriz(),cargas:FB.getData(\u0027USERS/\u0027+e.parameter.user+\u0027/cargas\u0027),version:FB.getData(\u0027CFG/VERSION\u0027)}\n  }\n  \n  return ContentService.createTextOutput(JSON.stringify(result)).setMimeType(ContentService.MimeType.JAVASCRIPT)\n}"},{"id":"949df66d-772e-49df-9b2b-4bb05746acd5","name":"b. login","type":"server_js","source":"function Login(e) { const userData \u003d FB.getData(\u0027USERS/\u0027+e.user.replace(/\\./g,\u0027,\u0027));\n                    return userData? userData.pass \u003d\u003d e.pass? Object.assign(userData,{cfg:FB.getData(\u0027CFG\u0027),pass:null}):null:null}\n\nfunction changePass(e) {\n  let user \u003d FB.getData(\u0027USERS/\u0027+e.user.replace(/\\./g,\u0027,\u0027));\n  if(user.pass !\u003d e.old){user \u003d {title:\u0027error en actualizar\u0027,icon:\u0027error\u0027}}\n  else{FB.setData(\u0027USERS/\u0027+e.user.replace(/\\./g,\u0027,\u0027)+\u0027/pass\u0027,e.nw);user \u003d {title:\u0027actualizado\u0027,icon:\u0027success\u0027}}\n  return user\n}\n\nfunction saveImg(data,id,folder){\n  const blob \u003d Utilities.newBlob(Utilities.base64Decode(data,Utilities.Charset.UTF_8),\"image/jpeg\",id);\n  return \u0027https://drive.google.com/uc?id\u003d\u0027+DriveApp.getFolderById(folder).createFile(blob).getId();\n}\n\nconst timer \u003d (e) \u003d\u003e Utilities.formatDate(e? new Date(e):new Date(),\u0027America/Buenos_Aires\u0027,\u0027dd/MM/yyyy HH:mm\u0027)\n\nfunction getFile(sheetName,folder) {\n  let result  \u003d false;\n  const files \u003d DriveApp.getFolderById(folder).getFiles()\n  while(files.hasNext()){\n      const file \u003d files.next();\n      if(file.getName() \u003d\u003d sheetName){result \u003d SpreadsheetApp.openById(file.getId())}\n  }\n  return result;\n}\n\nfunction getFolder(folderName,folderBase){\n  let result \u003d false;\n  const folders \u003d DriveApp.getFolderById(folderBase).getFolders();\n  while(folders.hasNext()){\n    const folder \u003d folders.next();\n    if(folder.getName() \u003d\u003d folderName){result \u003d folder.getId() }\n  }\n  if(result \u003d\u003d false){result \u003d DriveApp.getFolderById(folderBase).createFolder(folderName).getId()}\n  return result\n}\n\nfunction telegram(site,msg) {\n  const id \u003d FB.getData(\u0027CFG/SITES/\u0027+site+\u0027/telegram\u0027);\n  if(id){\n    const url  \u003d \u0027https://api.telegram.org/bot1869773451:AAFCr_TqklgXRzfrZ6E-JTuFO7HSiYo0ENU/sendMessage\u0027;\n    const data \u003d {\"method\": \"post\",\"payload\": {\"method\":\"sendMessage\",\"chat_id\":id,\"text\":msg}};\n    UrlFetchApp.fetch(url, data);\n  }\n}\n\n"},{"id":"c6f1e42d-2eeb-4a86-bda8-54e06b146e38","name":"c. tickets","type":"server_js","source":"const openTK \u003d ()\u003d\u003e Object.values(FB.getData(\u0027APPS/TK\u0027)).map(r\u003d\u003eObject.assign(r.data,{creado:r.log[0].time,obs:r.log[0].obs}))\n\nfunction setTK(e){\n\n  let result \u003d {title:\u0027Ooops!\u0027,text:\u0027tuvimos un problema con el TK\u0027,icon:\u0027error\u0027};\n  e.log.time \u003d Utilities.formatDate(new Date(),\u0027America/Buenos_Aires\u0027,\u0027dd/MM/yyyy HH:mm\u0027);\n  \n  if(e.log.action \u003d\u003d \u0027gestionar\u0027){  /**** SI GESTIONA EL TECNICO -\u003e SUMO HORAS *****/\n    const myhour \u003d FB.getData(\u0027USERS/\u0027+e.log.user.replace(/\\./g,\u0027,\u0027)+\u0027/cargas/\u0027+new Date().getDay())\n    FB.setData(\u0027USERS/\u0027+e.log.user.replace(/\\./g,\u0027,\u0027)+\u0027/cargas/\u0027+new Date().getDay(),myhour+parseInt(e.data.time))\n  }\n  \n  const perfil \u003d FB.getData(\u0027USERS/\u0027+e.log.user.replace(/\\./g,\u0027,\u0027)+\u0027/perfil\u0027)\n  if(!e.data.id){ /****** SI ES NUEVO TICKET ******/\n    if([\u0027Inspeccion visual de UPS\u0027,\u0027Reparacion UPS\u0027].includes(e.data.sub)){e.log.action \u003d \u0027cerrar\u0027}\n    else if(e.data.item \u003d\u003d \u0027Cotizar\u0027){e.log.action \u003d \u0027gestionar\u0027}\n\n    var mOb \u003d {data:Object.assign(e.data,{id:setIDN()}),log:{0:e.log}};\n    if(perfil !\u003d \u0027tecnico\u0027){telegram(e.data.site,e.log.user+\u0027 crea el tk \u0027+mOb.data.id+\u0027 : \u0027+e.data.sub+\u0027 - \u0027+e.log.obs)}\n    result  \u003d {title:\u0027Bien!\u0027,text:\u0027creamos el TK \u0027+mOb.data.id+\u0027 con éxito\u0027,icon:\u0027success\u0027,id:mOb.data.id}\n  }\n  else{ /*** SI ES UN TICKET ABIERTO ***/\n    var mOb \u003d FB.getData(\u0027APPS/TK/\u0027+e.data.id);\n    mOb.log[mOb.log.length] \u003d e.log\n    if(e.log.action \u003d\u003d \u0027cotizar\u0027){mOb.data.item \u003d \u0027Cotizar\u0027;e.log.action \u003d \u0027gestionar\u0027}\n    result  \u003d {title:\u0027Bien!\u0027,text:\u0027actualizamos el TK \u0027+e.data.id+\u0027 con éxito\u0027,icon:\u0027success\u0027}\n  }\n\n  if(FB.getData(\u0027CFG/APPS/TK/\u0027+e.data.item+\u0027/\u0027+e.data.sub) \u0026\u0026 perfil \u003d\u003d \u0027tecnico\u0027){e.log.action \u003d \u0027cerrar\u0027}\n  \n  if(e.log.file){ /*** SI HAY UNA FOTO ***/\n    const folder \u003d getFolder(mOb.data.item,getFolder(mOb.data.site,\u00271ZsK9sE8wBUQDjd6qC1lOAnOIAZvWM_K5\u0027))\n    e.log.file \u003d saveImg(e.log.file,mOb.data.id+\u0027 - \u0027+e.log.action,folder)\n  }\n\n  if(e.data.qr){setQR(mOb.data.id,e)} /*** SI GESTIONA QR ***/\n\n  mOb.data.progress \u003d {nuevo:\u0027nuevo\u0027,gestionar:\u0027gestionado\u0027,supervisar:\u0027supervisado\u0027,cerrar:\u0027cerrado\u0027,reabrir:\u0027reabierto\u0027}[e.log.action]\n  result.progress   \u003d mOb.data.progress;\n  \n  if(mOb.data.progress \u003d\u003d \u0027cerrado\u0027){   /*** SI SE ESTA CERRANDO EL TK ***/\n    const sheet \u003d getFile(new Date().getFullYear(),\u002710cCpKRA-kqZLvEgxXcVs-k0DetcWWXXh\u0027).getSheetByName(new Date().getMonth()+1)\n    sheet.appendRow([mOb.data.id,mOb.data.site,mOb.data.sector,mOb.data.item,mOb.data.sub,mOb.data.q,mOb.data.time,JSON.stringify(mOb.log)]);\n    FB.setData(\u0027APPS/TK/\u0027+mOb.data.id,{})\n  }\n  else{{FB.setData(\u0027APPS/TK/\u0027+mOb.data.id,mOb)}}\n\n  return result\n}\n\nfunction setIDN(){ /*** importante no borrar: creo nuevo numero de tk***/\n  const id \u003d parseInt(PropertiesService.getScriptProperties().getProperty(\u0027LastTK\u0027))+1\n  PropertiesService.getScriptProperties().setProperty(\u0027LastTK\u0027,id);\n  return id\n}\n"},{"id":"9c3308e9-13dd-4649-b859-f8e2ddc7f666","name":"d. monitoreo","type":"server_js","source":"const getMonitor \u003d ()\u003d\u003e Object.values(FB.getData(\u0027APPS/MONITOREO\u0027)).map(r\u003d\u003e Object.assign(r.data,{progress: r.data.FS ? \u0027OUT SERVICE\u0027:\u0027OPERATIVO\u0027}))\n\nfunction setQR(id,e){\n  \n  let equipo \u003d FB.getData(\u0027APPS/MONITOREO/\u0027+e.data.qr);\n\n  if(e.data.qrop \u003d\u003d \u0027FS\u0027){\n    e.log.obs \u003d \u0027EQUIPO FUERA DE SERVICIO: \u0027+e.log.obs\n    if(equipo.data.FS \u003d\u003d null){\n      equipo.data.FS \u003d e.log.time\n      mailer(equipo,FB.getData(`CFG/SITES/${equipo.data.site}`).alerta.join(\u0027,\u0027),false)\n    }\n  }\n  else if(equipo.data.FS \u0026\u0026 e.data.qrop \u003d\u003d \u0027OK\u0027){\n    SpreadsheetApp.openById(\u00271KJU0nWv-ztTQmrraEsRK5Xry-VBZtw6yKLJDWCyJmS4\u0027).getSheetByName(\u0027DB\u0027).appendRow([e.data.qr,equipo.data.FS,e.log.time])\n    delete equipo.data.FS\n    e.log.obs \u003d \u0027EQUIPO NUEVAMENTE OPERATIVO: \u0027+e.log.obs\n    mailer(e.data.qr,true,equipo.data,equipo.log)\n  }\n\n  if(equipo.log \u003d\u003d null){equipo.log \u003d []}\n  equipo.log.push({time:e.log.time,item:e.data.sub,obs:e.log.obs+\u0027 - TK: \u0027+id,file:e.log.file})\n  FB.setData(\u0027APPS/MONITOREO/\u0027+e.data.qr,equipo)\n}\n\nfunction posterQR(e){\n  const data  \u003d FB.getData(\u0027APPS/MONITOREO/\u0027+e+\u0027/data\u0027);\n  const value \u003d [[e],[\u0027PLATAFORMA\u0027],[data.site],[\u0027EQUIPO\u0027],[data.equipo],[\u0027SECTOR\u0027],[data.sector]]\n  SpreadsheetApp.openById(\u00271Ru2BGqKOID0OOuFl3I6ZBZ6kUNZcQlPAx_v551vs-eI\u0027).getSheetByName(\u0027poster\u0027).getRange(17,21,7,1).setValues(value);\n  SpreadsheetApp.flush();\n  return \u0027https://docs.google.com/spreadsheets/d/1Ru2BGqKOID0OOuFl3I6ZBZ6kUNZcQlPAx_v551vs-eI/export?format\u003dpdf\u0026gid\u003d585816309\u0026size\u003dA4\u0026portrait\u003dtrue\u0026scale\u003d1\u0027\n}\n\nfunction mailer(equipo,destini,action){\n  const mail \u003d {\u0027to\u0027:destini,\u0027subject\u0027:`INFRAPP: EQUIPO ${equipo.data.id} ${!action ? \u0027SALE DE SERVICIO\u0027:\u0027ENTRA EN SERVICIO\u0027}`}\n  const auth \u003d {user:\"infrapp@ar.atento.com\",\"pass\":\"MiDMXSrvTBhFQ3vHzwQ7\"}\n  mail.html  \u003d `\u003c!DOCTYPE html\u003e\u003chtml\u003e\u003chead\u003e\u003cdiv id\u003dhead\u003e\u003cstyle type\u003d\u0027text/css\u0027\u003e\n      th{border: 1px solid #dddddd;text-align: center;padding: 5px;font-size: 70%;text-align: center}\n      td{background-color: #5499C7;border: 1px solid #dddddd;text-align: center;padding: 5px;font-size: 70%;text-align: center}\n      tr:nth-child(even) {background-color: #ECECEC}\n      p {font-family:arial, sans-serif;text-align: center;font-size:16px;width:70%;margin:auto}\n      footer{position:fixed;left:0;bottom:1%;width:100%;text-align:center}\n      html, body {height: 100%;}\u003c/style\u003e\u003c/div\u003e\u003c/head\u003e\n    \u003cbody align\u003dcenter\u003e\u003cp\u003eDetallamos los datos del equipo\u003c/p\u003e\u003cbr\u003e\n      \u003ctable align\u003dcenter\u003e\u003ctr\u003e${[\u0027ID\u0027,\u0027SITE\u0027,\u0027SECTOR\u0027,\u0027UBICACION\u0027,\u0027TIPO\u0027].map(r\u003d\u003e`\u003ctd\u003e${r}\u003c/td\u003e`).join(\u0027\u0027)}\u003c/tr\u003e\n      \u003ctr\u003e${[\u0027id\u0027,\u0027site\u0027,\u0027sector\u0027,\u0027ubicacion\u0027,\u0027tipo\u0027].map(r\u003d\u003e`\u003cth\u003e${equipo.data[r]}\u003c/th\u003e`).join(\u0027\u0027)}\u003c/tr\u003e\u003c/table\u003e\u003cbr\u003e\n      \u003cp\u003e\u003cstrong\u003eLOGS\u003c/strong\u003e\u003c/p\u003e\n      \u003ctable align\u003dcenter\u003e\u003ctr\u003e${[\u0027FECHA\u0027,\u0027USER\u0027,\u0027TAREA\u0027,\u0027OBSERVACIONES\u0027].map(r\u003d\u003e`\u003ctd\u003e${r}\u003c/td\u003e`).join(\u0027\u0027)}\u003c/tr\u003e\n      ${equipo.log.map(r\u003d\u003e`\u003ctr\u003e\u003cth\u003e ${r.time} \u003c/th\u003e\u003cth\u003e ${r.user} \u003c/th\u003e\u003cth\u003e ${r.item} \u003c/th\u003e\u003cth\u003e ${r.obs} \u003c/th\u003e\u003c/tr\u003e`).join(\u0027\u0027)}\n    \u003c/table\u003e\u003cbr\u003e\n    \u003cfooter\u003e\u003cp\u003eSolicitamos tenga a bien gestionar los tickets correspondientes en \u003ca href\u003d\"https://infrapp.web.app\"\u003ewww.infrapp.web.app\u003c/a\u003e\u003c/p\u003e\n    \u003cstrong\u003eDepartamento de Infraestructura\u003cbr\u003eAtento Argentina\u003c/strong\u003e\u003c/footer\u003e\u003c/body\u003e\u003c/html\u003e`\n\n  const options \u003d {method:\"post\",headers:{\"Content-Type\":\"application/json\"},payload:JSON.stringify({auth:auth,mail:mail})}\n  UrlFetchApp.fetch(\u0027https://infrapp.herokuapp.com/send-email\u0027,options)\n}"},{"id":"5debaf11-10f6-4fbd-a57a-48496cb6b7f6","name":"e. matriz","type":"server_js","source":"function getMatriz(result \u003d {}) {\n  const now    \u003d new Date();now.setDate(now.getDate() + 3)\n  const SS     \u003d getFile(new Date().getFullYear(),\u002717XfhaYj29Jc61aEeAUdegFl64YxsgaI_\u0027).getSheetByName(\u0027board\u0027).getDataRange().getValues()\n  SS[2].slice(3).forEach((r,n)\u003d\u003e{result[r] \u003d {GES:SS.slice(3).filter(i\u003d\u003ei[n+3]\u003cnow).map(i\u003d\u003e{return {[i[2]]:timer(i[n+3])}})}})\n  //const APB \u003d FB.getData(`APPS/MATRIZ`)\n  //Object.keys(APB).forEach(r\u003d\u003e{result[r][\u0027APB\u0027] \u003d Object.values(APB[r]).map(i\u003d\u003e{return APB[r][Object.keys(i)[0]]})})\n  //Logger.log(result)\n  return result\n}\n\nfunction setFirma(e){\n  const url \u003d saveImg(e.firma,timer(),getFolder(e.user,\u00271WWdUeZMjLQgiVz-ZuxRP81ZoZBh1I8RY\u0027));\n  FB.setData(`USERS/${e.user.replace(/\\./g,\u0027,\u0027)}/firma`,url)\n  return {response:`guardamos los datos con éxito`,url:url}\n}\n\nfunction getForm(e){\n  let result \u003d getFile(e,\u00271yJj8aP7EjB7LRYHH6gkzgDjkXxB9t3UM\u0027)\n  if(result){result \u003d result.getSheetByName(\u0027index\u0027).getDataRange().getValues().map(r\u003d\u003e[r[0],r[1],r[2],r[3],r[4]]).splice(3)}\n  return result\n}\n\nfunction setForm(e){\n  //e \u003d {site:\u0027EJERCITO DEL NORTE\u0027,form:\u00274.1 Analisis Bacteriologico\u0027}\n  const user   \u003d FB.getData(`USERS/${e.user.replace(/\\./g,\u0027,\u0027)}`);\n  const site   \u003d FB.getData(`CFG/SITES/${e.site}`).nomeclatura;\n  const mes    \u003d new Date().getMonth()+1\n  const folder \u003d getFolder(mes+` - `+month[mes-1],getFolder(new Date().getFullYear(),getFolder(e.site,getFolder(e.form,`1nquvT1yaDxWLsaZ55zcYjOrhEuSNW-1Q`))))\n  const matriz \u003d getFile(new Date().getFullYear(),`17XfhaYj29Jc61aEeAUdegFl64YxsgaI_`).getSheetByName(site)\n  const date \u003d Utilities.formatDate(new Date(),\u0027America/Buenos_Aires\u0027,\u0027dd/MM/yyyy HH:mm\u0027).split(\u0027 \u0027)[0]\n\n  if(JSON.parse(e.content).type \u003d\u003d `files`){\n    Object.values(JSON.parse(e.content).data).forEach((r,n)\u003d\u003e{saveImg(r,n+` - `+e.form,folder)})\n    const idx \u003d matriz.getDataRange().getValues().map(r\u003d\u003er[0]).indexOf(e.form)+1\n    matriz.getRange(idx,mes+4).setFormula(`\u003dHYPERLINK(\"https://drive.google.com/drive/folders/${folder}\",\"${date}\")`)\n    matriz.getRange(idx,3).setValue(date)\n  }\n  return getMatriz()\n}"},{"id":"b1f3d12a-0f94-43e3-bb30-f168e2c953a9","name":"f. igm","type":"server_js","source":"function getIgm(site){\n  \n  /**********CREO ARCHIVO IGM***********/\n  const folder \u003d DriveApp.getFolderById(getFolder(site,\u00271HCCPnr9PngHQq29y6YXQtUuF1ldOf4Pv\u0027))\n  const SS     \u003d SpreadsheetApp.openById(DriveApp.getFileById(\u00271fvMKSu0NNqzfnupW0z2R7ytWAlqJk3vaGypM7fwIrg8\u0027)\n                                                 .makeCopy(folder).setName(`IGM - ${month[new Date().getMonth()]} ${new Date().getFullYear()}`).getId())\n  SS.getSheetByName(\u0027IGM\u0027).getRange(4,2).setValue(site)\n  /**********ANALIZO MATRIZ***********/\n  const matriz \u003d SpreadsheetApp.openById(\u0027169gMy0p0272-6PcVM-pE7d-LSmZyqevo66UBSGos1Zk\u0027).getSheetByName(\u0027board\u0027).getRange(3,2,27,10).getValues()\n  const tabla  \u003d matriz.slice(1).map(r\u003d\u003e [r[1],,,,,,,,r[(matriz[0].indexOf(site))]])\n  SS.getSheetByName(\u0027IGM\u0027).getRange(45,4,20,9).setValues(tabla.splice(0,20))\n  SS.getSheetByName(\u0027IGM\u0027).getRange(66,4,5,9).setValues(tabla.slice(1))\n  /**********ANALIZO BONIFICADAS***********/\n  let bono \u003d {},fin \u003d {},pen \u003d {};\n  const tickets \u003d getFile(new Date().getFullYear(),\u002710cCpKRA-kqZLvEgxXcVs-k0DetcWWXXh\u0027).getSheetByName(new Date().getMonth())\n  tickets.getDataRange().getValues().forEach(r\u003d\u003e{\n    if(r[1] \u003d\u003d site){\n      if(r[3] \u003d\u003d \u0027Adecuaciones\u0027){\n        if(!bono[r[4]]){bono[r[4]] \u003d {q:0,t:0}}\n        bono[r[4]].q +\u003d 1;\n        if(parseInt(r[6])){bono[r[4]].t +\u003d parseInt(r[6])}\n      }\n      if(JSON.parse(r[7])[0].action \u003d\u003d \u0027nuevo\u0027){if(!fin[r[4]]){fin[r[4]] \u003d 0};fin[r[4]] +\u003d 1}\n    }\n  })\n  if(bono.length \u003e 11){bono.splice(11,bono.length)}\n  SS.getSheetByName(\u0027IGM\u0027).getRange(118,9,Object.keys(bono).length,12).setValues(Object.keys(bono).map(r\u003d\u003e{return [bono[r].q,,r,,,,,,,,,bono[r].t/60]}))\n  /**********ANALIZO RELEVAMIENTOS PENDIENTES***********/\n  Object.values(FB.getData(\u0027APPS/TK\u0027)).forEach(r\u003d\u003e{\n    if(r.data.site \u003d\u003d site \u0026\u0026 r.log[0].action \u003d\u003d \u0027nuevo\u0027){\n      if(!pen[r.data.sub]){pen[r.data.sub] \u003d 0}pen[r.data.sub] +\u003d 1\n    }\n  })\n  let rel \u003d Object.keys(fin).map(r\u003d\u003e[\u0027Finalizado\u0027,,pen[r],r]).concat(Object.keys(pen).map(r\u003d\u003e[\u0027Pendiente\u0027,,pen[r],r]))\n  if(rel.length \u003e 27){rel.splice(27,rel.length)}\n  if(rel.length){SS.getSheetByName(\u0027IGM\u0027).getRange(151,2,rel.length,4).setValues(rel)}\n\n  SpreadsheetApp.flush()\n  return \u0027https://docs.google.com/spreadsheets/d/\u0027+SS.getId()\n}\n"},{"id":"ab6db9f5-7be2-4eda-99f5-176830259e7f","name":"h. guardias","type":"server_js","source":"function openWatch(){return API.FB(`APPS/GUARDIAS`)}\n\nfunction setWatch(e){\n\n  e \u003d {\"user\":\"cagutierrez@atento.com\",\"site\":\"EJERCITO DEL NORTE\",\"id\":\"1011\",\"item\":\"Climatización\",\"sub\":\"Contingencia de operacion\",\"init\":\"27/10/2021  23:32\",\"end\":\"27/10/2021  23:32\",\"impacto\":\"Impacto en Operacion: 0\",\"obs\":\"Esto es una prueba\",\"asis\":\"presencial\",\"duracion\":\"01:00\"}\n\n  if(e.id \u003d\u003d \u0027Nuevo Registro\u0027){e.id \u003d API.getID(\u0027guardia\u0027)}\n\n  if(e.end){\n    const folder \u003d DriveApp.getFolderById(`1YMGoWGC4SPLvEdx8Xgj66ClLLp-ydwFF`)\n    const value  \u003d [e.id,e.site,e.user,e.item,e.sub,e.impacto,e.init,e.end,e.asis,e.duracion,e.obs]\n    const resg   \u003d `1LbqClZWrcIE9EcGonq9LDG8ku2Lqa8gL2hBKV9il48Y`\n    API.getFile(folder,new Date().getFullYear(),resg).getSheetByName(new Date().getMonth()+1).appendRow(value)\n    API.FB(`APPS/GUARDIAS/${e.id}`,{})\n  }\n  else{API.FB(`APPS/GUARDIAS/${e.id}`,e)}\n  return `${e.id} actualizado`\n}\n"},{"id":"39a4cabe-5990-44d4-b383-077bb923acc0","name":"i. waha","type":"server_js","source":"function openWaha() {\n  const base   \u003d SpreadsheetApp.openById(\u00271OIcICe16AF94y_JbvMEcylHGUo__2H-dMax--YmqeoI\u0027).getSheetByName(\u0027CURSO\u0027).getDataRange().getValues()\n  const result \u003d base.slice(2).map(r\u003d\u003e {\n    const json \u003d {id:r[0],site:r[4],tipo:r[1],progress:r[2],empleado:JSON.parse(r[8]).name,owner:r[6],wsp:JSON.parse(r[8]).wsp,activo:r.slice(9,15)}\n    json.despacho \u003d JSON.parse(r[8]).addr \u003d\u003d \u0027PLATAFORMA\u0027 ? \u0027PLATAFORMA\u0027:\u0027DOMICILIO\u0027;\n    return json\n  })\n  return result\n}\n\nfunction getWaha(e){\n\n  const base   \u003d SpreadsheetApp.openById(\u00271OIcICe16AF94y_JbvMEcylHGUo__2H-dMax--YmqeoI\u0027);\n  let result;\n\n  if(isNaN(e)){result \u003d {data:[],search:\u0027name\u0027,fun:(i)\u003d\u003ei[8].toLowerCase().includes(e.toLowerCase())}}\n  else if(e.length \u003d\u003d 8){result \u003d {data:[],search:\u0027dni\u0027,fun:(i)\u003d\u003ei[7] \u003d\u003d e}}\n  else if(e.length \u003d\u003d 5){result \u003d {data:[],search:\u0027id\u0027,fun:(i)\u003d\u003ei[0] \u003d\u003d e}}\n\n  [\u0027CURSO\u0027,\u0027ENTREGADO\u0027,\u0027CANCELADO\u0027].forEach(r\u003d\u003ebase.getSheetByName(r).getDataRange().getValues().filter(i\u003d\u003eresult.fun(i)).forEach(i\u003d\u003eresult.data.push(i)))\n\n  return result\n}"},{"id":"ce271fc5-54b4-4449-90f8-28ecf4265b26","name":"h. acceso","type":"server_js","source":"//GET BASE DE DATOS DE EMPLEADOS\nconst getAccessBase \u003d ()\u003d\u003e SpreadsheetApp.openById(\u0027164K70yVP5PUZj2qlYVQ_bBME4bMJdLHLJYwX0yuHDto\u0027).getSheetByName(\u0027DB\u0027).getDataRange().getValues()\n//GET SHEET DE REGISTRO\nconst getAccesFile \u003d (e)\u003d\u003e getFile(e.year,getFolder(e.site,\u00271QfY3YHeV-gu-sRHMqtyEtRFAZN1qbyCW\u0027)).getSheetByName(e.month).getDataRange().getValues();\n\n\n//CARGO REGISTROS DE ACCESO\nfunction upAccData(site,data){\n  const date \u003d new Date(),rows \u003d Object.values(data)\n  const SS   \u003d SpreadsheetApp.openById(getSheet(site,date.getFullYear().toString())).getSheetByName((date.getMonth()+1).toString())\n  SS.getRange(SS.getLastRow()+1,1,rows.length,4).setValues(rows)\n  return true\n}\n\n\nfunction searchAccs(e){\n\n}"}]}